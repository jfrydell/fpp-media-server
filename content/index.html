<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listen</title>
  <script>
    // Clock sync
    var server_offset = 0; // (server time - client time) in seconds
    async function sync_clock() {
      let ws = new WebSocket(`ws://${window.location.host}/ws`);
      await new Promise((resolve, reject) => {
        ws.onopen = resolve;
        ws.onerror = reject;
      });
      let server_offsets = [];
      for (let i = 0; i < 10; i++) {
        server_offsets.push(await benchmark_latency(ws));
      }
      server_offset = server_offsets.reduce((a, b) => a + b) / server_offsets.length;
    }
    async function benchmark_latency(ws) {
      return await new Promise((resolve, reject) => {
        let start = audio_ctx.currentTime;
        ws.send(0);
        ws.onmessage = (event) => {
          let end = audio_ctx.currentTime;
          let middle = parseFloat(event.data);
          let offset = (middle - (start + end) / 2);
          console.log("client times: " + start + ", " + end);
          console.log("server time: " + middle);
          console.log("latency: " + (end - start));
          console.log("offset: " + offset);
          resolve(offset);
        };
      });
    }

    // Audio context
    var audio_ctx = null;
    var audio_source = null;
    var audio_start = 0; // client time when audio started playing
    var filename = null; // filename of the current song
    var id = -1; // id of the current status
    async function update_audio_status() {
      if (!server_offset) {
        await sync_clock();
      }
      let status = await fetch("/api/status")
        .then(response => response.json())
      if (status.id == id) {
        return;
      }
      if (!status.filename) {
        filename = null;
        document.getElementById('current-song').innerHTML = "N/A";
        audio_start = audio_ctx.currentTime;
        if (audio_source) {
          audio_source.stop();
        }
        log("stopped audio");
      } else {
        filename = status.filename;
        document.getElementById('current-song').innerHTML = filename;
        audio_start = status.start_time - server_offset;
        await load_audio(filename);
        log("loaded " + filename);
      }
      id = status.id;
    }
    async function load_audio(filename) {
      if (audio_source) {
        audio_source.stop();
      }
      const response = await fetch(filename);
      let buffer = await response.arrayBuffer();
      await audio_ctx.decodeAudioData(buffer, (audio_buffer) => {
        audio_source = audio_ctx.createBufferSource();
        audio_source.buffer = audio_buffer;
        audio_source.connect(audio_ctx.destination);

        // Start audio at the correct time
        let initial_time = audio_ctx.currentTime + 0.5 - audio_start;
        audio_source.start(audio_ctx.currentTime + 0.5, initial_time);
      });
    }

    async function start_everything() {
      log("starting...");
      audio_ctx = new AudioContext();
      await sync_clock();
      await update_audio_status();
      setInterval(sync_clock, 10000);
      setInterval(update_audio_status, 2000);
      log("started");
    }
    
    // Event log
    function log(message) {
      document.getElementById('log').innerHTML = message + "<br>" + document.getElementById('log').innerHTML;
      console.log(message);
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("start-btn").onclick = start_everything;
    });
  </script>
</head>

<body>
  <h1>Welcome to Test</h1>
  <p>Currently Playing: "<span id="current-song"></span>"</p>
  <button id="start-btn">Start</button>
  <h2>Event Log</h2>
  <p id="log"></p>
</body>
</html>