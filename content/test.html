<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Audio</title>
  <script>
    var current_filename = "";
    var current_starttime = 0;
    var audio;
    var audioSource;
    document.addEventListener("DOMContentLoaded", function() {
      audio = document.getElementById("audio");
      audioSource = document.getElementById("audioSource");
      setInterval(updateAudio, 1000);
    });
    async function updateAudio() {
      let response = await fetch("/api/start_time");
      let data = await response.json();
      // console.log(data);
      if (current_filename != data.filename) {
        console.log("new file: " + data.filename)
        audioSource.src = data.filename;
        audio.load();
        audio.play();
        current_filename = data.filename;
      }
      current_starttime = data.start_time;
      correct_drift();
    }
    function correct_drift() {
      // Drift correction unnecessary if not playing
      if (audio.paused) {
        return;
      }
      // drift = how far behind audio is
      let correct_time = Date.now() / 1000 - current_starttime;
      console.log("correct time " + correct_time);
      let drift = correct_time - audio.currentTime;
      document.getElementById("log").innerHTML = `drift: ${drift}` + "<br>" + document.getElementById("log").innerHTML;
      if (Math.abs(drift) > 0.5) {
        console.log("MAJOR DRIFT");
        audio.currentTime = correct_time;
      } else if (Math.abs(drift) > 0.1) {
        // Calculate needed speed change for next 1 seconds to correct drift (positive drift means next 0.5 seconds should go faster)
        let speed_change = 1 + drift / 1;
        audio.playbackRate = speed_change;
        console.log("minor drift: " + speed_change);
      } else {
        audio.playbackRate = 1;
        console.log("no drift");
      }
    }
  </script>
</head>
<body>
  <h1>Test Audio (Polling)</h1>
  <audio id="audio" controls>
    <source id="audioSource" src="">
  </audio>
  <p id="log"></p>
</body>
</html>